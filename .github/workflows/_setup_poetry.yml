name: Reusable Poetry Setup for most tasks
on:
  workflow_call:

jobs:
  setup:
    steps:
      #----------------------------------------------
      # check-out repo and set-up python
      #----------------------------------------------
      - name: Check out repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up python
        uses: actions/setup-python@v2
        with:
          python-version: 3.10.2
      #----------------------------------------------
      # install & configure poetry in cache
      #----------------------------------------------
      ## -- due to bug with github caching, only one cache works in a job, so
      ## -- to fix this the two caches are currently combined...
      - name: Load cached Poetry installation
        id: cached-poetry-install
        uses: actions/cache@v2
        with:
          ## path: ~/.local
          ## key: poetry-install-0
          path: |
            .venv
            ~/.local
          key: povenv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install Poetry
        if: steps.cached-poetry-install.outputs.cache-hit != 'true'
        uses: snok/install-poetry@v1
        with:
          version: 1.1.12
          virtualenvs-create: true
          virtualenvs-in-project: true
      #----------------------------------------------
      # install/activate dependencies
      #----------------------------------------------
      ## - name: Load cached venv
      ##   id: cached-poetry-dependencies
      ##   uses: actions/cache@v2
      ##   with:
      ##     path: .venv
      ##     key: pvenv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

# end
