name: Overall Release Process
on: workflow_dispatch
jobs:
  full_test:
    uses: nigelm/gh_release/.github/workflows/_full_tests.yml@main

  release:
    runs-on: ubuntu-latest
    concurrency: release
    needs: full_test
    environment: deployment

    steps:
      - name: Set up repository
        uses: nigelm/gh_actions_python_poetry_setup@v1
        with:
          python-version: 3.10.2
          poetry-version: 1.1.12
          fetch-depth: 0

      #----------------------------------------------
      # release
      #----------------------------------------------
      - name: Semantic Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # source .venv/bin/activate
          git config user.name github-actions
          git config user.email github-actions@github.com
          poetry run semantic-release publish

      - name: run post release test
        run:  make test

      - name: upload release
        run: poetry config repositories.test-pypi https://test.pypi.org/legacy/
      - run: poetry config pypi-token.test-pypi ${{ secrets.PYPI_TOKEN }}
      - run: poetry publish --build --repository test-pypi

      - name: Setup Git Commit Info
        run:  git config user.name 'github-actions[bot]' && git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Publish docs
        run:  poetry run mkdocs gh-deploy

# end
